namespace $.$$ {

  export type $bog_prof_app_vaka_vacancy_data = {
    id: string
    name: string
    area?: { name?: string }
    employer?: { name?: string }
    salary?: { from?: number; to?: number; currency?: string }
    snippet?: { requirement?: string; responsibility?: string }
    published_at?: string
    alternate_url?: string
  }

  export class $bog_prof_app_vaka extends $bog_prof_app_vaka {

    @ $mol_mem
    query(next?: string) {
      return this $mol_state_arg value('q', next) ?? ''
    }

    @ $mol_mem
    area_name(next?: string) {
      return this.$$mol_state_arg.value('area_name', next) ?? 'Россия'
    }

    @ $mol_mem
    area_id() {
      const map: Record<string, string> = {
        'Россия': '113',
        'Москва': '1',
        'Санкт-Петербург': '2',
      }
      return map[this.area_name()] ?? '113'
    }

    @ $mol_mem
    private search_stamp(next?: number) {
      return next ?? 0
    }

    @ $mol_action
    search() {
      this.search_stamp(Date.now())
    }

    @ $mol_mem
    vacancies(): readonly $bog_prof_app_vaka_vacancy_data[] {
      // привязываем к нажатию поиска
      this.search_stamp()

      const q = this.query().trim()
      if (!q) return []

      const url = `https://api.hh.ru/vacancies?text=${ encodeURIComponent(q) }&area=${ this.area_id() }&per_page=20`

      try {
        const data = this.$.$mol_fetch.json(url) as { items?: unknown[] }
        const items = (data.items ?? []) as $bog_prof_app_vaka_vacancy_data[]
        return items
      } catch (err) {
        this.$.$mol_log3_fail({ place: '$bog_prof_app_vaka', message: 'HH fetch failed', hint: String(err) })
        return []
      }
    }

    @ $mol_mem
    vacancy_ids() {
      return this.vacancies().map(v => v.id)
    }

    @ $mol_mem_key
    vacancy(id: string) {
      return this.vacancies().find(v => v.id === id) ?? null
    }

    @ $mol_mem
    menu_title() {
      const q = this.query().trim()
      return `VibeJobs — ${ q || 'поиск' }`
    }
  }

  export class $bog_prof_app_vaka_item extends $.$bog_prof_app_vaka_item {
    @ $mol_mem
    title() {
      return this.vacancy()?.name ?? ''
    }

    @ $mol_mem
    url() {
      return this.vacancy()?.alternate_url ?? ''
    }

    @ $mol_mem
    meta() {
      const v = this.vacancy()
      if (!v) return ''
      const parts: string[] = []
      if (v.employer?.name) parts.push(v.employer.name)
      if (v.area?.name) parts.push(v.area.name)
      if (v.published_at) parts.push(new Date(v.published_at).toLocaleDateString())
      return parts.join(' • ')
    }

    @ $mol_mem
    salary() {
      const s = this.vacancy()?.salary
      if (!s) return 'З/п не указана'
      const from = s.from
      const to = s.to
      const cur = s.currency ?? ''
      if (from && to) return `З/п ${ from }–${ to } ${ cur }`
      if (from) return `З/п от ${ from } ${ cur }`
      if (to) return `З/п до ${ to } ${ cur }`
      return 'З/п не указана'
    }

    @ $mol_mem
    snippet() {
      const sn = this.vacancy()?.snippet
      const req = sn?.requirement?.replace(/<[^>]+>/g, '')
      const resp = sn?.responsibility?.replace(/<[^>]+>/g, '')
      return [req, resp].filter(Boolean).join(' • ')
    }
  }
}

